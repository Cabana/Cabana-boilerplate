require 'JSON'
require 'pp'
require 'colorize'
require 'closure-compiler'
require 'fileutils'
require 'httparty'

task default: :build

directory '../resources/css'
directory '../resources/js'
directory '../resources/img'
directory '../resources/fonts'

desc 'Build all resources'
task build: [
  'build:scss_utils',
  'build:css',
  'build:js',
  'build:fonts',
  'build:img'
] do
  puts 'Resources have been built!'.magenta
  puts "Total size of app.css is now #{file_size_in_kb('../resources/css/app.css')} kb"
  puts "Total size of app.js is now #{file_size_in_kb('../resources/js/app.js')} kb"
end

namespace :build do
  # desc 'Build scss utilities'
  task :scss_utils do
  end

  desc 'Build css'
  task css: ['../resources/css', 'scss_utils'] do
    # system "compass compile --sass-dir sass --css-dir ../resources/css --out-style compressed --force"
    system "compass compile"
    replace_paths
  end

  desc 'Minify and concatenate js'
  task js: ['../resources/js'] do
    compilation_levels = {
      simple: 'SIMPLE_OPTIMIZATIONS',
      advanced: 'ADVANCED_OPTIMIZATIONS',
      whitespace: 'WHITESPACE_ONLY'
    }
    contents = Closure::Compiler.new(compilation_level: compilation_levels[:simple]).compile_files paths_to_js_files
    File.open "../resources/js/app.js", "w" do |file|
      file.write contents
    end
    replace_paths
    puts "overwrite".yellow + " ../resources/js/app.js"
  end

  desc 'Copy images'
  task img: ['../resources/img'] do
    remove_files_in '../resources/img'
    img_paths.each do |img_path|
      FileUtils.copy_file img_path, "../resources/#{img_path}"
    end
  end

  desc 'Copy fonts'
  task fonts: ['../resources/fonts'] do
    remove_files_in '../resources/fonts'
    font_paths.each do |font_path|
      FileUtils.copy_file font_path, "../resources/#{font_path}"
    end
  end
end

# TODO: Test this on Windows
desc "Build and export project to path"
task :export, :path do |t, args|
  # build the resources folder
  Rake::Task["build"].invoke

  # get path to export folder
  export_folder_path = "../#{args[:path].split('/').last}"

  # make the export folder
  FileUtils.mkdir export_folder_path

  # compile php files into html and place them in the export folder
  if folder_contains_php? '../'
    compile_php_files_into export_folder_path
  end

  # copy each html file into the export folder
  Dir["../*.html"].each do |file|
    filename = file.split('/').last
    FileUtils.copy_file file, "#{export_folder_path}/#{filename}"
  end

  # copy the resources folder into the export folder
  cp_r "../resources", export_folder_path

  # copy the export folder to the specified path
  cp_r export_folder_path, args[:path]

  # remove the export folder from the project
  FileUtils.rm_r export_folder_path
end

def compile_php_files_into folder_path
  project_path = Dir.pwd.gsub('/src', '')
  current_project = project_path.split('/').last

  cp_r project_path, '/Volumes/inetpub-1/Cabana/Kunder/wwwroot/frontend'

  Dir['../*.php'].each do |php_file|
    php_file.gsub! '../', ''
    file = File.new "#{folder_path}/#{php_file.gsub('php', 'html')}", "w"
    file.puts HTTParty.get("http://kunder.cabana.dk/frontend/#{current_project}/#{php_file}").body
    file.close
  end

  FileUtils.rm_r "/Volumes/inetpub-1/Cabana/Kunder/wwwroot/frontend/#{current_project}"
end

def replace_paths
  JSON.parse(File.read 'paths.json').each do |key, value|
    if File.exists? "../#{key}"
      contents = File.read "../#{key}"
      contents.gsub! value["replace"], value["with"]
      File.open "../#{key}", "w" do |file|
        file.write contents
      end
    end
  end
end

def js_components
  JSON.parse File.read File.join 'js', 'components.json'
end

def paths_to_js_files
  js_files = []
  js_components.each do |name, path|
    js_files << File.join('js', path)
  end
  js_files
end

def file_size_in_kb file_path
  size = File.size(file_path) / 1024.0
  size.round
end

def font_paths
  fonts = []
  Dir["fonts/**/*"].each do |path|
    fonts << path unless path.include?("config.json")
  end
  fonts
end

def img_paths
  Dir["img/**/*"]
end

def remove_files_in folder_path
  Dir["#{folder_path}/**/*"].each do |file|
    FileUtils.rm_rf file
  end
end

def folder_contains_php? folder
  true if Dir["#{folder}/*.php"].length > 0
end
